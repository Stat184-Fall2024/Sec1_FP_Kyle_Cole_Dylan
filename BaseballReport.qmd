---
title: "Baseball Report"
author: "Kyle Gilbert, Cole Kvasnak, Dylan _"
highlight-style: github
format:
  html:
    code-fold: true
  pdf:
    geometry: 
      - top=30mm
      - left=30mm
editor: visual
---

```{r}
#| label: load-pkgs
#| code-summary: "Packages"
#| message: false
#| echo: false

library(tidyverse)
library(knitr)
library(ggplot2)
```

```{r}
#| label: load-datasets
#| echo: false

# Set working directory to path to repo
#setwd("~/path/to/repo")

# Read in data
master <- read.csv("data/Master.csv")
salaries <- read.csv("data/Salaries.csv")
batting <- read.csv("data/Batting.csv")
batting_post <- read.csv("data/BattingPost.csv")
fielding <- read.csv("data/Fielding.csv")
fielding_of <- read.csv("data/FieldingOF.csv")
pitching <- read.csv("data/Pitching.csv")
pitching_post <- read.csv("data/PitchingPost.csv")
teams <- read.csv("data/Teams.csv")
```

```{r}
#| label: data-wrangling
#| echo: false

### Computing wins above replacement (WAR)

## Position players

# Using Baseball Reference's definition of WAR (aka bWAR):
# https://www.baseball-reference.com/about/war_explained.shtml
# https://www.baseball-reference.com/about/war_explained_position.shtml
# https://www.baseball-reference.com/about/war_explained_pitch.shtml

AVG_RUNS_PER_WIN = 10 # Constant for average number of runs per win, Baseball Reference assumes this is 10 

# Compute the league average runs per at bat
avg_runs_per_ab <- mean(teams$R / teams$AB)
# Replacement level is defined as scoring 80% of the league average runs per at bat
replacement_level_runs_per_ab = avg_runs_per_ab * 0.8

# Compute bWAR for 21st century Yankees hitters
nyy_batting <- batting %>%
  # Filter cases to 21st century Yankees players
  filter(yearID > 1999 & teamID == "NYA") %>%
  # Add columns for the WAR computation
  mutate(
    TB = H + X2B + 2 * X3B + 3 * HR, # total bases (TB)
    RC = ifelse((AB + BB) > 0, (H + BB) * TB / (AB + BB), 0), # runs created (RC)
    replacement_level_runs = replacement_level_runs_per_ab * AB, # replacement runs
    runs_above_replacement = RC - replacement_level_runs, # runs above replacement
    WAR = runs_above_replacement / AVG_RUNS_PER_WIN # bWAR
  ) %>%
  # Sort by descending WAR
  arrange(desc(WAR)) %>%
  # Drop all columns beside playerID, yearID, teamID, WAR
  select(playerID, yearID, teamID, WAR)

# For validation purposes, 2007 Alex Rodriguez' WAR was about 9.2

## Pitchers

# Park factors: adjust for hitter friendly ballparks
OLD_NYY_STADIUM_PF = 1.02
NEW_NYY_STADIUM_PF = 1.04

# Compute league average runs allowed per 9 innings
lg_RA9 = (sum(teams$RA) / sum(teams$IPouts / 3)) * 9
# Replacement level is defined as allowing 20% more runs per 9 innings than the league average
replacement_RA9 = lg_RA9 * 1.2

# Compute bWAR for 21st century Yankees pitchers
nyy_pitching <- pitching %>%
  # Filter cases to 21st century Yankees players
  filter(yearID > 1999 & teamID == "NYA") %>%
  # Add columns for the WAR computation
  mutate(
    RA9 = (R / (IPouts / 3)) * 9, # runs allowed per 9 innings
    RA9_adj = ifelse(yearID > 2008, RA9 * NEW_NYY_STADIUM_PF, RA9 * OLD_NYY_STADIUM_PF), # runs allowed per 9 innings, adjusted for home ballpark
    WAR = (replacement_RA9 - RA9)* ((IPouts / 3) / 9) / AVG_RUNS_PER_WIN, # bWAR
  ) %>%
  # Sort by descending WAR
  arrange(desc(WAR)) %>%
  # Drop all columns beside playerID, yearID, teamID, WAR
  select(playerID, yearID, teamID, WAR)

# Note: computed pitching bWAR does not take into account the "leverage" factor which scales the WAR based on if the pitcher is a starter or reliever. Thus, searches of the pitching WAR yields slightly different results.
```

**Project Description:**

The goal of this final R project is to analyze the percentage of a team's salary cap allocated to specific players from 2000 to now and to explore the factors driving these players' compensation levels.

**Questions to answer:**

-   **Player Salary Insights**

    -   How does the percentage of salary cap each player earns correlate with their performance metrics (e.g., batting average, home runs, WAR)?

    -   What is the distribution of salaries across different positions (pitcher, catcher, etc.) for the Yankees compared to other teams?

-   **Team-Level Analysis**

    -   How does the Yankees' average player salary compare to that of other MLB teams?

    -   What percentage of the Yankees' salary cap is spent on top-performing players compared to the league average?

-   **Historical Trends**

    -   How has the percentage of the salary cap allocated to top-paid players changed over the years for the Yankees and other teams?

    -   Are there trends in salary allocation related to team performance in playoffs or championships?

-   **Position-Based Analysis**

    -   Are certain positions (e.g., pitchers, shortstops) allocated a higher percentage of the salary cap across MLB teams? How does this compare with the Yankees?

    -   Do players in specific positions receive more or less than their performance justifies?

-   **Team Strategy Insights**

    -   Does a higher percentage of salary cap spent on star players correlate with better overall team performance?

    -   How do the Yankees' salary allocation strategies compare to teams with similar or better performance records?

-   **League-Wide Comparisons**

    -   How do the Yankees rank in terms of salary cap utilization efficiency compared to other MLB teams?

    -   Are there any anomalies or outliers in salary allocations across the league?

-   **Contract Lengths and Salaries**

    -   Do longer contracts for Yankees players correlate with a higher percentage of the salary cap allocation?

    -   How does contract length influence the perceived value of players?

-   **Demographics and Salaries**

    -   Are there correlations between player age, experience, or nationality and the percentage of the salary cap they receive?

    -   How do rookie salaries as a percentage of salary caps compare between the Yankees and other teams?

-   **Revenue vs. Salaries**

    -   Does the Yankees' revenue have a stronger correlation with salary cap allocations compared to other teams?

    -   How does team revenue impact the overall spending strategy on players?

Note: At some point in analysis, define equations for WAR
